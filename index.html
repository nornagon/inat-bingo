<!doctype html>
<style>
.square {
  display: block;
  text-decoration: none;
  position: relative;
  background-repeat: no-repeat;
  background-size: cover;
  background-position: center;
}
.card {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  aspect-ratio: 1;
  max-width: 100%;
}
.square label {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 50%);
  color: white;
  font-family: sans-serif;
  font-size: 14px;
  padding: 0 4px;
}
web-complete .suggestions {
  position: absolute;
  z-index: 1;
}
web-complete .suggestion {
  display: block;
}
web-complete .active {
  background: blue;
}

html, body { height: 100%; margin: 0; }

body {
  display: grid;
  grid-template-rows: 1fr auto;
  justify-items: center;
  padding: 10px;
  row-gap: 10px;
}
* { box-sizing: border-box; }
</style>
<script type="module" src="https://unpkg.com/web-complete"></script>
<script type="module">
import { h, render } from 'https://unpkg.com/preact@latest?module';
import { useState, useEffect } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';

// https://gist.github.com/blixt/f17b47c62508be59987b
function mkRandom(seed) {
  return () => {
    return ((seed = seed * 16807 % 2147483647) - 1) / 2147483646
  }
}
function shuffle(rand, array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle...
  while (currentIndex != 0) {

    // Pick a remaining element...
    randomIndex = Math.floor(rand() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

function capitalize(str) {
  return str[0].toUpperCase() + str.substr(1)
}

function capitalizePiece(piece) {
  // \p{Word} matches any word in Unicode, \w does not, apparently
  // https://stackoverflow.com/questions/3576232/how-to-match-unicode-words-with-ruby-1-9#3576559
  let bits

  // Match contractions like d'Silva
  if (bits = /^([a-z]['’])(\w+)/.exec(piece))
    return `${bits[1]}${capitalize(bits[2])}`
  // Match okina and similar leading punctuation characters that will match \p{Word}
  else if (bits = /^([ʻ])(\w+)/.exec(piece))
    return `${bits[1]}${capitalize(bits[2])}`
  else if (bits = /(.*?)(\w+)(.*)/.exec(piece))
    return `${bits[1]}${capitalize(bits[2])}${bits[3]}`
  else
    return piece

}

// https://github.com/inaturalist/inaturalist/blob/1606e8963a351b9d685a2bac64d40b7f955135e1/app/helpers/taxa_helper.rb#L184
function capitalizeName(comname) {
  const uncapitalized = [
    "à",
    "a",
    "and",
    "con",
    "da",
    "dal",
    "de",
    "dei",
    "del",
    "des",
    "di",
    "du",
    "e",
    "in",
    "la",
    "o",
    "on",
    "of",
    "the"
  ]
  const comname_pieces = comname.split( /\s+/ )
  return comname_pieces.map((piece, i) => {
    if (i > 0 && uncapitalized.includes( piece.toLowerCase() ))
      return piece.toLowerCase()
    else if (i === comname_pieces.length - 1)
      return piece.split("-").map((s) =>
        uncapitalized.includes(s.toLowerCase())
          ? s.toLowerCase()
          : capitalizePiece(s)
      ).join( "-" )
    else
      return capitalizePiece(piece)
  }).join(" ")
}


function Square({taxon}) {
  return h('a', {
    class: 'square',
    href: 'https://inaturalist.org/taxa/' + taxon.id,
    style: {'background-image': `url(${taxon.default_photo.medium_url})`}
  }, [
    //h('img', {src: taxon.default_photo.square_url}),
    h('label', null, taxon.preferred_common_name ? capitalizeName(taxon.preferred_common_name): taxon.name)
  ])
}

const initialLocation = (location.hash.substr(1)|0) || 854

function App() {
  const [date] = useState(new Date)
  function seed(date) {
    return ('' + date.getUTCFullYear() + date.getUTCMonth())|0
  }
  const [species, setSpecies] = useState(null)
  const [placeId, setPlaceId] = useState(initialLocation)
  const [place, setPlace] = useState(null)

  useEffect(() => {
    location.hash = placeId
    const controller = new AbortController();
    const { signal } = controller;
    fetch(`https://api.inaturalist.org/v1/places/${encodeURIComponent(placeId)}`, {signal}).then(r => r.json()).then(place => {
      setPlace(place.results[0])
    })
    return () => { controller.abort() }
  }, [placeId])

  useEffect(() => {
    function hashchange() {
      setPlaceId((location.hash.substr(1)|0) || 854)
    }
    window.addEventListener('hashchange', hashchange)
    return () => {
      window.removeEventListener('hashchange', hashchange)
    }
  })

  useEffect(() => {
    const controller = new AbortController();
    const { signal } = controller;
    setSpecies(null)
    const endOfLastMonth = new Date(date)
    endOfLastMonth.setUTCDate(0)
    const url = new URL('https://api.inaturalist.org/v1/observations/species_counts')
    for (const [k, v] of Object.entries({
      verifiable: true,
      spam: false,
      place_id: placeId,
      locale: 'en-US',
      preferred_place_id: 1,
      hrank: 'species',
      'month[]': date.getUTCMonth()+1,
      created_d2: endOfLastMonth.toISOString().substr(0, 10)
    })) url.searchParams.set(k, v)
    fetch(url, { signal }).then(r => r.json()).then(species => {
      const rand = mkRandom(seed(date))
      const squares = shuffle(rand, species.results.slice()).slice(0, 25)
      setSpecies(squares)
    })
    return () => { controller.abort() }
  }, [date, placeId])
  return [
    /*h('web-complete', {
      suggestionGenerator: async (text) => {
        const suggestions = await fetch(
          'https://api.inaturalist.org/v1/places/autocomplete?q='+text
        ).then(x => x.json())
        return suggestions.results.map(r => {
          return {
            text: r.display_name,
            value: r
          }
        })
      },
      maxSuggestions: 10,
      minInput: 2,
      onselected: (e) => {
        console.log(e.detail)
        setPlaceId(e.detail.value.id)
        e.target.querySelector('input').blur()
      }
    }),*/
    species
      ? species.length
        ? h('div', {class: 'card'},
            species.map(s => h(Square, {taxon: s.taxon})))
        : h('div', null, 'no species')
      : h('div', null, 'loading...'),
    h('div', null, [
      `iNaturalist Bingo // ${date.getUTCFullYear()}-${(date.getUTCMonth()+1).toString().padStart(2, '0')} // `,
      place ? place.display_name : '...'
    ])
  ];
}

render(h(App), document.body);
</script>
